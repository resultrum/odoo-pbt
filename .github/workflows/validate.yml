name: Validate - Configuration & Dependencies

on:
  push:
    branches: [ main, develop ]
    paths:
      - '.env.example'
      - 'requirements*.txt'
      - 'docker-compose*.yml'
      - 'Dockerfile*'
      - '.github/workflows/validate.yml'
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-docker-compose:
    runs-on: ubuntu-latest
    name: Validate Docker Compose Files
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Docker Compose
        run: pip install docker-compose

      - name: Load environment variables
        run: cp .env.example .env

      - name: Validate docker-compose.yml
        run: docker-compose config -f docker-compose.yml > /dev/null
        env:
          PROJECT_NAME: odoo-template
          DB_HOST: db
          DB_PORT: 5432
          DB_NAME: odoo
          DB_USER: odoo
          DB_PASSWORD: odoo
          POSTGRES_PASSWORD: odoo
          ODOO_ADMIN_PASSWORD: admin
          ODOO_PORT: 8069
          ODOO_LONGPOLLING_PORT: 8072

      - name: Validate docker-compose.dev.yml
        run: docker-compose -f docker-compose.yml -f docker-compose.dev.yml config > /dev/null
        env:
          PROJECT_NAME: odoo-template
          DB_HOST: db
          DB_PORT: 5432
          DB_NAME: odoo
          DB_USER: odoo
          DB_PASSWORD: odoo
          POSTGRES_PASSWORD: odoo
          ODOO_ADMIN_PASSWORD: admin
          ODOO_PORT: 8069
          ODOO_LONGPOLLING_PORT: 8072

      - name: Validate docker-compose.prod.yml
        run: docker-compose -f docker-compose.yml -f docker-compose.prod.yml config > /dev/null
        env:
          PROJECT_NAME: odoo-template
          DB_HOST: db
          DB_PORT: 5432
          DB_NAME: odoo
          DB_USER: odoo
          DB_PASSWORD: odoo
          POSTGRES_PASSWORD: odoo
          ODOO_ADMIN_PASSWORD: admin
          ODOO_PORT: 8069
          ODOO_LONGPOLLING_PORT: 8072
          DOCKER_REGISTRY: ghcr.io
          DOCKER_ORG: resultrum

  validate-dockerfile:
    runs-on: ubuntu-latest
    name: Validate Dockerfiles
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Validate Dockerfile syntax
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile || echo "⚠️ Some issues found (non-critical)"

      - name: Validate Dockerfile.enterprise syntax
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile.enterprise || echo "⚠️ Some issues found (non-critical)"

      - name: Validate Dockerfile.community syntax
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile.community || echo "⚠️ Some issues found (non-critical)"

      - name: Validate Dockerfile.prod syntax
        run: |
          docker run --rm -i hadolint/hadolint < Dockerfile.prod || echo "⚠️ Some issues found (non-critical)"

  validate-env:
    runs-on: ubuntu-latest
    name: Validate .env Configuration
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Check .env.example syntax
        run: |
          echo "Checking .env.example..."
          # Validate that each line is either empty, comment, or KEY=VALUE format
          grep -v '^#' .env.example | grep -v '^$' | while IFS= read -r line; do
            if [[ ! "$line" =~ ^[A-Z_][A-Z0-9_]*= ]]; then
              echo "❌ Invalid format: $line"
              exit 1
            fi
          done
          echo "✅ .env.example format is valid"

      - name: Check required environment variables
        run: |
          REQUIRED_VARS=("DB_HOST" "DB_PORT" "DB_NAME" "DB_USER" "DB_PASSWORD")
          for var in "${REQUIRED_VARS[@]}"; do
            if ! grep -q "^$var=" .env.example; then
              echo "❌ Missing required variable: $var"
              exit 1
            fi
          done
          echo "✅ All required variables present"

  validate-scripts:
    runs-on: ubuntu-latest
    name: Validate Shell Scripts
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Check script permissions
        run: |
          echo "Checking script permissions..."
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              if [ -x "$script" ]; then
                echo "✅ $script is executable"
              else
                echo "⚠️ $script is not executable"
              fi
            fi
          done

      - name: Validate setup-new-project.sh
        continue-on-error: true
        run: |
          if [ -f "scripts/setup-new-project.sh" ]; then
            shellcheck scripts/setup-new-project.sh || echo "⚠️ Some style issues (non-critical)"
          fi

      - name: Validate pycharm-setup.sh
        continue-on-error: true
        run: |
          if [ -f "scripts/pycharm-setup.sh" ]; then
            shellcheck scripts/pycharm-setup.sh || echo "⚠️ Some style issues (non-critical)"
          fi

      - name: Validate other shell scripts
        continue-on-error: true
        run: |
          for script in scripts/*.sh; do
            if [ -f "$script" ] && [ "$script" != "scripts/setup-new-project.sh" ] && [ "$script" != "scripts/pycharm-setup.sh" ]; then
              echo "Checking $script..."
              shellcheck "$script" || echo "⚠️ Some issues in $(basename $script) (non-critical)"
            fi
          done

  validate-documentation:
    runs-on: ubuntu-latest
    name: Validate Documentation
    continue-on-error: true

    steps:
      - uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f "README.md" ]; then
            echo "❌ README.md not found"
            exit 1
          fi
          echo "✅ README.md exists"

      - name: Check docs directory
        run: |
          if [ ! -d "docs" ]; then
            echo "⚠️ docs/ directory not found"
          else
            echo "✅ docs/ directory exists"
          fi

      - name: Validate markdown links
        continue-on-error: true
        run: |
          # Simple markdown link validation
          grep -r '\[.*\](.*\.md)' . --include="*.md" | while IFS=: read -r file link; do
            echo "Checking links in: $file"
          done
          echo "✅ Markdown link check completed"
